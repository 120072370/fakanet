$(function(){
    //初始化uid
//    uid = $("[name=uid]").val();
//    show_type = $("[name=show_type]").val();
//
//    change_contact_msg(buy_contact_type,$("#text-obligate"),$("#obligate-desc"));

    // 判断是否支持placeholder
    var support = hasPlaceholderSupport();
    if(!support){
        placeholder();
    }
//    // 判断是否需要显示优惠卷
//    if("undefined" != typeof show_qkmm){
//        if (show_qkmm == 1){
//            $(".card-password").show();
//        }    
//    }

//    // 判断要不要显示优惠卷框
//    if("undefined" != typeof show_yhj){
//        if (show_yhj == 1){
//            $(".favourable").show();
//        }    
//    }

//    // 判断是否需要显示联系方式
//    var sh_lxfs = $(".contact-value").text();
//    if (sh_lxfs == "") {
//        $("#merchant-contact").remove();
//    } else {
//        $("#merchant-contact").show();
//    }

//    // 判断是否需要需要将联系商户按钮去除
//    var data = $(".contact").attr("data");
//    if (data == "3") {
//        $(".contact").show();
//    }else{
//        $(".contact").remove();
//    }

//    // 判断是否需要将商户网站按钮去除
//    var site = $(".site").attr("data");
//    if (site == "") {
//        $(".site").remove();
//    }else{
//        $(".site").show();
//    }

    // 进入商户网站
    $(".site").click(function(event) {
        window.open($(this).attr("data"));
    });

    // 联系商户QQ
    $(".contact").click(function(event) {
        window.open($(this).attr("url"));
    });

//    // 初始选中第一个付款方式
//    if ($(".payment-list>div").size() == 0) {
//        // 连一个支付方式都没有
//        $(".payment-null-msg").css("display","block");
//    }
//    $(".payment-list>div").eq(0).addClass('active');
//    // 初始选中第一家银行
//    $(".bank-list>i").eq(0).addClass('active');

    // 绑定分类切换
    __bind_cate_list();
//    // 绑定商品切换
//    __bind_product_list();
//    // 绑定购买数量切换
    __bind_inventory_list();
//    // 绑定购买数量框切换
//    __bind_text_quantity_change();
//    // 绑定联系方式框改变事件
//    __bind_text_obligate_change();
//    // 绑定取卡密码编辑框改变事件
//    __bind_text_card_password_change();
//    //绑定优惠卷编辑框改变事件
//    __bind_favourable_change();
//    // 绑定付款方式的切换事件
    __bind_payment_list();
//    // 绑定银行的切换事件
//    __bind_bank_list();
//    // 绑定优惠卷失去焦点事件
////    __bind_favourable_blur();
//    // 银行搜索
//    __bind_bank_query_change();    
//    // 开始支付
//    __band_to_pay();
//    // 绑定进入付款
//    __bind_go_pay();

//    if ($(".cate-list>a").size() == 0) {
//        // 连分类都没有
//        $(".cate-null-msg").show();
//        $(".product-null-msg").show();
//        $(".inventory-header>span").text("(无法加载)");
//        return;
//    }
    //初始选中第一个分类    
    $(".cate-list>a").eq(0).click();

//    var fl_id = $(".cate-list>a").eq(0).attr("data");


    // 判断有没有分类
    // 中间部分需要自适应
    var main_height   = $("#kfk-main").height();
    var window_height = $(window).height() - 69 - 74;
    if (window_height >= main_height + 60) {
        $("#kfk-main").css("margin-top",(window_height - main_height) / 8 + "px");
    }

//    // 清空优惠卷
//    $("#text-favourable").keyup(function(event) {
//        // 清空优惠卷
//        window.yhj_data = null;
//    });

//    /*取消确认订单的按钮*/
//    $(".btn_cancel,.btn_change").click(function(event) {
//        if (click_to_pay_count == 0) {
//            close_order_box();
//        }else{
//            _msg("如果您已经付款成功,但是系统还未显示付款成功,那请先牢记您的订单号和联系方式,等候几分钟后自行查询订单,您的订单号：" + $("[name=order_num]").val(),-1,"关闭");
//            close_order_box();
//        }
//    });
//
//    //已完成支付和付款完成按钮
//    $('.btn_pay_end,.btn-final,.str_pay_end').click(function(event) {
//        var order_num = $("[name=order_num]").val();
//        if (order_num == null) {
//            msg("获取订单号失败!");
//            return;
//        }
//        window.open("/order/state/" + order_num + "/" + $("[name=link]").val() + ".html");
//    });

    /**
     * 取消等待
     * @date   2017-02-08T19:30:26+0800
     */
    $(".btn-cancel").click(function(event) {
        hide_paying();
    });

    // _msg_botton 关闭土司框
    $("._msg_botton").click(function(event) {
        _msg_close();
    });

//    // 换一个微信二维码图片
//    $(".str_pay_refurbish").click(function(event) {
//        var src = $("[name=ewm]").prop("src");
//        $("[name=ewm]").prop("src",src + "&6");
//        _msg("已更换!");
//    });
});
//
//
//function __bind_go_pay(){
//    //进入付款
////    $(".btn_go").click(function(event) {
////        var uid       = $("[name=uid]").val();
////        var fl_id     = $(".cate-list>.active").attr("data");
////        var pr_id     = $(".product-list>.active").attr("pr");
////        var count     = get_product_count();
////        var link      = $("[name=link]").val();
////        var link_man  = $("#text-obligate").val();
////        var pay_type  = $(".payment-list>.active").attr('data');
////        var pay_name  = $(".payment-list>.active").attr('msg');
////        var order_num = $("[name=order_num]").val();
////        var pay_bank  = $(".bank-list>.active").attr("data");
////        var yhj       = $.trim($("#text-favourable").val());
////        if (show_qkmm == 1) {
////            var qkmm  = $.trim($("#text-card-password").val());
////        }else{
////            var qkmm  = "";
////        }
////        //显示加载中的状态
////        start_loading();
////
////        _async = true;
//        
////        $.ajax({  
////            type: "post",  
////            url: "/controller/overt/control.html",  
////            data : {_f: "client.total",_m: "to_pay",fl_id: fl_id,pr_id: pr_id,link:link,contact:link_man,pay_type: pay_type,pay_name: pay_name,number: count,order_num: order_num,pay_bank: pay_bank,open_page_time: open_page_time,uid:uid,qkmm:qkmm,yhj:yhj},  
////            async : _async,  
////            success : function(data){  
////                if (data.state == "ok") {
////                    if (pay_type == "1") {
////                        if (data.data == "ALISAOMA") {
////                            $("#ddqr").removeAttr('style');
////                            $("[name=ewm]").attr("src", data.msg);
////                            $(".wx_desc").text("请用支付宝客户端扫描下面的二维码进行支付");
////                            calc_left_wx();
////                        }else if (data.data == "ALIURL") {
////                            location.href = data.msg;
////                        }else{
////                            $("#alipaysubmit").remove();
////                            $("body").append(data.msg);
////                            $("[type=submit]").click();
////                            //显示
////                            show_paying();
////                        }
////                    } else if (pay_type == "2") {
////                        $("#ddqr").removeAttr('style');
////                        $("[name=ewm]").attr("src", data.msg);
////                        $(".wx_desc").text("请用微信客户端扫描下面的二维码进行支付");
////                        calc_left_wx();
////                    }else if (pay_type == "3") {
////                        $("#ddqr").removeAttr('style');
////                        $("[name=ewm]").attr("src", data.msg);
////                        $(".wx_desc").text("请用QQ客户端扫描下面的二维码进行支付");
////                        calc_left_wx();
////                    }else{
////                        //显示
////                        $("#__formid").remove();
////                        $("body").append("<a href='"+ data.msg +"' target='_blank' id='__formid'>..</a>");
////                        document.getElementById("__formid").click();
////                        show_paying();
////                    }
////                    click_to_pay_count = click_to_pay_count + 1;
////                    clearInterval(window.time_id);
////                    /*开始每隔5秒访问服务器,确定订单是否已经发货*/
////                    window.time_id = self.setInterval("check_pay('" + order_num + "')", 5000);
////                } else {
////                    _msg(data.msg);
////                }
////                close_loading();
////            }  
////        }); 
//    });
//}


////模拟窗口post提交
//function openWindowWithGet(url, keys, values) {
//    var html = "<form id='__formid' target='_blank' method='get' action='" + url + "'>";
//    if (keys != null && values != null && (keys.length == values.length)) {
//        for (var i = 0; i < keys.length; i++) {
//            html += "<input type='hidden' name='" + keys[i] + "' value='" + values[i] + "'/>";
//        }
//    }
//    html += "<input type='submit' id='_send' value='提交' style='display:none;'></form>";
//    $("body").append(html);
//    return true;
//}

// 开始支付
//function __band_to_pay(){
//    $(".btn-pay").click(function(event) {
//        var _this = $(".product-list>.active");
//        if (_this == null || _this.size() == 0) {
//            //说明商品是不存在的
//            _msg("您还没有选择商品!");
//            return;
//        }
//
//        var min_buy  = parseInt(_this.attr("min-buy"));
//        var max_buy  = parseInt(_this.attr("max-buy"));
//        var pr_price = _this.attr("price");
//        var pr_name  = _this.text().replace("(" + pr_price + " 元)","").substr(0,40) + "...";
//        var count    =  get_product_count();
//        if (count == false) {
//            _msg("您输入的购买数量有误!");
//            return;
//        }
//
//        if (min_buy != null && count < min_buy && min_buy != "0") {
//            _msg("此商品有限购设置,最小起购:" + min_buy + "件");
//            return;
//        }else if (max_buy != null && count > max_buy && max_buy != "0") {
//            _msg("此商品有限购设置,最多只能买:" + max_buy + "件");
//            return;
//        }
//
//        //前台判断库存是否足够简单判断
//        if (show_type != 3) {
//            var kc = $(".inventory-header>span").text();
//            var patt_res = kc.match("([1-9]{1}[0-9]{0,})");
//            if (patt_res != null && patt_res[0] != null) {
//                if (parseInt(count) > parseInt(patt_res[0])) {
//                    _msg("当前商品的库存没有这么多!");
//                    return;
//                }
//            }
//            if (kc == "(0)" || kc == "(暂无库存)") {
//                _msg("商品库存不足!");
//                return;
//            }
//        }
//
//        var lxfs = $.trim($("#text-obligate").val());
//        var lxfs_result = check_pay_contact(buy_contact_type,lxfs);
//        if (lxfs_result != true) {
//            // 如果是开启了自定义预留联系方式则提示他
//            // if (obligate_open == "1") {
//            //     _msg("请输入正确的" + obligate_type);
//            // }else{
//                _msg(lxfs_result);
//            // }
//            $("#text-obligate").focus().select();
//            return;
//        }
//
//        //使用了取卡密码
//        if (show_qkmm == 1) {
//            var qkmm = $.trim($("#text-card-password").val());
//            var qkmm_result = check_mj_qkmm(qkmm);
//            if (qkmm_result != true || qkmm == "请输入取卡密码") {
//                _msg("取卡密码长度在2-32位之间");
//                $("#text-card-password").focus().select();
//                return;
//            }
//            $("tr>.td-right").eq(7).text(qkmm); //取卡密码
//            $(".tr-qkmm").show();
//        }
//
//        // 总价详情里显示的优惠卷信息
//        var yhj_sum_info = "";
//        // 判断优惠卷,
//        if (show_yhj == 1) {
//            var yhj = $.trim($("#text-favourable").val());
//            if (yhj != "" && yhj != "选填、请输入优惠卷") {
//                if (check_favourable_value(yhj) == false) {
//                    $("text-favourable").focus();
//                    _msg("优惠卷格式不正确!");
//                    return false;
//                }
//
//                // 判断优惠卷是否可以用
//                if(favourable_exits() == false){
//                    $("text-favourable").focus();
//                    _msg("您输入的优惠卷不可用!");
//                    return false;
//                }
//
//                // 如果优惠卷在当前页面使用
//                if (check_current_select_unable() == true) {
//                    // 如果优惠卷能在当前选择的商品中使用
//                    if (check_current_select_unable() == true) {
//                        var money = pr_price * count;
//                        if (money == 0 || money == null){
//                            _msg("订单价格不可以是0元!");
//                            return false;
//                        }
//                        // 计算出优惠后的价格
//                        var favourable_money =  favourable_reduce_money(money);
//                        if (typeof favourable_money == "string") {
//                            // 可能是订单没有达到使用条件，需要给予提示
//                            _msg(favourable_money);
//                            return false;
//                        }
//
//                        if (window.yhj_data.price_type == "2") {
//                            // 金额优惠卷
//                            yhj_sum_info = " -" + window.yhj_data.value + "元 （优惠卷）";
//                        }else{
//                            yhj_sum_info = " *" + window.yhj_data.value + "折 （优惠卷）";
//                        }
//                    }else{
//                        _msg("您输入的优惠卷不可用在当前所购买的商品!");
//                        return false;
//                    }
//                }else{
//                    _msg("您输入的优惠卷在当前页面不可用!");
//                    return false;
//                }
//            }
//        }
//
//        var add_msg = "";
//        var pay_type = $(".payment-list>.active").attr('data');
//        if (pay_type == "5") {
//            var pay_bank = $(".bank-list>.active").attr('data');
//            add_msg = "-" + $(".bank-list>.active").text();
//            if (pay_bank == null) {
//                _msg("请选择付款银行!");
//                return;
//            }
//        }
//
//        if ($(".money").text() * 1 > max_money) {
//            _msg("单个订单的实际支付金额不能大于" + max_money + "元!");
//            return;
//        }
//
//        var welfare_open = _this.attr("welfare_open");
//        var welfare_data = _this.attr("welfare_data");
//        var discount_result = get_discount(welfare_open,welfare_data,count);
//        //开始显示订单信息
//        $("tr>.td-right").eq(1).text(pr_name); //订单号
//        $("tr>.td-right").eq(2).text(getNowFormatDate()); //创建时间
//        $("tr>.td-right").eq(3).text($(".payment-list>.active").attr("msg") + add_msg); //付款方式
//        $("tr>.td-right").eq(4).text($("#text-obligate").val()); //联系方式
//        $("tr>.td-right").eq(5).text($(".money").text() + "元"); //应该付款金额
//        if (discount_result != false) {
//            $("tr>.td-right").eq(6).text(pr_price + "（单价）*" + count + "（数量）*" + discount_result.discount.toFixed(2) + " （折扣）" + yhj_sum_info); //应该付款金额
//        }else{
//            $("tr>.td-right").eq(6).text(pr_price + "（单价）*" + count + "（数量）" + yhj_sum_info); //应该付款金额
//        }
//        //取消之前的时钟
//        window.clearInterval(window.time_id);
//        //获取订单号
//        start_loading();
//        $.post('/controller/overt/control.html', {_f:"client.total",_m:"fecth_order_num"}, function(data, textStatus, xhr) {
//             if (data.state == "ok") {
//                $("[name=order_num]").val(data.msg);
//                $("tr>.td-right").eq(0).html($("[name=order_num]").val() + '<i style="font-size: 12px;font-style: normal;color: #f27f57;letter-spacing: 1px;margin-left: 5px;">(非常重要请保存)</i>'); 
//                //订单号
//                 calc_left();
//                //删除掉之前的支付宝post表单
//                $("#alipaysubmit").remove();
//             }else{
//                _msg("生成订单号失败,请稍后重试!");
//             }
//             close_loading();
//        });
//    });
//}

// 绑定分类列表的切换事件
function __bind_cate_list(){
    $(".cate-list>a").click(function(event) {
        //显示分类下面的商品
//        var fl_id = $(this).eq(0).attr("data");
//        $(".product-list>a").removeClass('active').addClass('hide');
//        $("#goods_list_new>a:eq(0)").addClass('active');
        //勾选第一个商品
        $(".cate-list>a").removeClass('active');
        $(this).addClass('active');
        
//        if ($(".product-list>[fl=" + fl_id + "]").size() == 0) {
//            // 说明分类下面没有商品
//            $(".product-null-msg").show();
//            $(".inventory-header>span").text("加载失败");
//        }else{
//            $(".product-null-msg").hide();
//            $(".product-list>[fl=" + fl_id + "]").eq(0).click();
//        }
    });
}

// 绑定商品列表的切换事件
//function __bind_product_list(){
//    
//    $(".goods_list_new a").click(function(event) {
//        console.log(event);
//        /*查询库存*/
////        if ($(this).hasClass('active') == false) {
////            if (show_type != 3) {
////                var fl_id = $(this).attr("fl");
////                var pr_id = $(this).attr("pr");
//////                show_stock(fl_id, pr_id);
////            }else{
////                $(".inventory-header>span").remove();
////            }
////        }
//
//        $(".goods_list_new a").removeClass('active');
//        $(this).addClass('active');
////        show_favourable($(this));
////        calc_money(); //更新价格信息
//    });
//}

// 绑定购买数量的切换事件
function __bind_inventory_list(){
    $(".inventory-list>a").click(function(event) {
        $(".inventory-list>a").removeClass('active');
        $(this).addClass('active');
        $("#text-quantity").val($(this).data('id'));
        $("#bottom_num").html('x'+$(this).data('id'));
        
//        $(".text-quantity-msg").hide();
//        calc_money(); //更新价格信息
changequantity()

    });
}

// 绑定付款方式的切换事件
function __bind_payment_list(){
    $(".payment-list div").click(function(event) {
        if ($(this).hasClass('active') == false) {
            $(".payment-list div").removeClass('active');
            $(this).addClass('active');

        }
    });
}

// 绑定付款方式的切换事件
function __bind_bank_list(){
    $(".bank-list>i").click(function(event) {
        if ($(this).hasClass('active') == false) {
            $(".bank-list>i").removeClass('active');
            $(this).addClass('active');
        }
    });
}

// 绑定购买数量编辑框的改变事件
function __bind_text_quantity_change(){
    $("#text-quantity").keyup(function(event) {
        var right = isPositiveNum($(this).val());
        if (right == false || right <= 0) {
            if ($(this).val() != "") {
                $(".text-quantity-msg").css('display', 'inline-block');
            } else {
                $(".text-quantity-msg").removeAttr('style');
            }
            $(".inventory-list>a").eq(0).addClass('active');
        } else {
            $(".inventory-list>a").removeClass('active');
            $(".text-quantity-msg").removeAttr('style');
        }
        calc_money(); //更新价格信息
    });
}

// 绑定联系方式编辑框的改变事件
function __bind_text_obligate_change(){
    $("#text-obligate").keyup(function(event) {
        var right = check_pay_contact(buy_contact_type,$.trim($(this).val()));
        if (right != true) {
            $(".text-obligate-msg").text(right);
            if ($(this).val() != "") {
                $(".text-obligate-msg").css('display', 'inline-block');
            } else {
                $(".text-obligate-msg").removeAttr('style');
            }
        } else {
            $(".text-obligate-msg").removeAttr('style');
        }
    });
}

// 绑定取卡密码编辑框的改变事件
function __bind_text_card_password_change(){
    $("#text-card-password").keyup(function(event) {
        var right = check_mj_qkmm($(this).val());
        if (right != true) {
            if ($(this).val() != "") {
                $(".text-card-password-msg").css('display', 'inline-block');
            } else {
                $(".text-card-password-msg").removeAttr('style');
            }
        } else {
            $(".text-card-password-msg").removeAttr('style');
        }
    });
}

// 绑定优惠卷编辑框改变事件
function __bind_favourable_change(){
    $("#text-favourable").keyup(function(event) {
        hide_yhj_error();
        hide_yhj_info();
        hide_prompt_favourable_used();
        var right = check_favourable_value($(this).val());
        if (right != true) {
            if ($(this).val() != "") {
                show_yhj_error("优惠卷长度在6-30位之间!");
            } else {
                $(".text-favourable-msg").removeAttr('style');
            }
        } else {
            $(".text-favourable-msg").removeAttr('style');
        }
    });
}

// 银行搜索
function __bind_bank_query_change(){
    $(".text-bank-query").keyup(function(event) {
        var exist = false;
        $(".bank-list>i").removeClass('hide');
        $(".bank-list>i").each(function(index,element){
            var key = $(".text-bank-query").val();
            if ($(this).text().indexOf(key) > -1) {
                exist = true;
            }else{
                $(this).addClass('hide');
            }
        });
        // 如果不存在也需要删除隐藏
        if (exist == false) {
            $(".bank-list>i").removeClass('hide');
        }else{
            // 选择第一个没有被隐藏的
            $(".bank-list>i").not('.hide').eq(0).click();
        }
    });
}

/**
 * 显示优惠卷错误信息
 * @date   2017-02-18T23:31:23+0800
 */
function show_yhj_error(msg){
    $(".text-favourable-msg").text(msg).css("display","inline").attr('vaild', 'false');;
}

/**
 * 隐藏优惠卷错误信息
 * @date   2017-02-18T23:31:34+0800
 */
function hide_yhj_error(){
    $(".text-favourable-msg").hide().removeAttr('vaild');
}

/**
 * 显示优惠卷信息总汇
 * @date   2017-02-18T23:55:29+0800
 */
function show_yhj_info(data){
    $(".favourable-info").find('.type').text(data.type);
    var start = "0";
    if (data.min_order_money != "0") {
        start = data.min_order_money;
    }
    if (data.price_type == "1") {
        $(".favourable-info").find('.content').text("买满" + start + "元立享" + data.value + "折");
    }else{
        $(".favourable-info").find('.content').text("买满" + start + "元立减" + data.value + "");       
    }

    // 写入有效期
    $(".date>.value").text(data.date);

    $(".favourable-info").show();
}

/**
 * 显示优惠卷信息
 * @date   2017-02-18T23:55:29+0800
 */
//function hide_yhj_info(data){
//    $(".favourable-info").hide();
//    // 同步数据
//    window.yhj_data = null;
//}
//
//// 绑定优惠卷编辑框的失去焦点事件
//function __bind_favourable_blur(){
//    // 检测优惠卷
//    $("#text-favourable").blur(function(){
//        var account_id = $("[name=uid]").val();
//        var value = $.trim($(this).val());
//        // 优惠卷为空就隐藏掉所有错误信息
//        if (value == "" || value == "选填、请输入优惠卷") {
//            // 显示优惠卷价格
//            calc_money(); //更新价格信息
//            hide_yhj_error();
//            hide_yhj_info();
//            del_favourable_font();
//            return;
//        }
//
//        if (check_favourable_value(value) == false) {
//            // 显示优惠卷价格
//            calc_money(); //更新价格信息
//            hide_yhj_info();
//            del_favourable_font();
//            show_yhj_error("优惠卷长度在6-30位之间!");
//            return;
//        }
//
//        $.post('/controller/overt/control.html?_mobile=1', {_f:"client.total",_m:"get_coupon",value:value,account_id:account_id}, function(data) {
//            if (data.state == "ok"){
//                hide_yhj_error();
//                // 同步数据
//                window.yhj_data = data.data;
//                if (check_current_page_unable() == false) {
//                    show_yhj_error("此页面的所有商品都不适用此优惠卷!");
//                    hide_yhj_info();
//                    window.yhj_data = null;
//                }else{
//                    // 添加惠字
//                    show_favourable_font(data.data);
//                    show_yhj_info(data.data);
//                }
//            }else{
//                hide_yhj_info();
//                show_yhj_error(data.msg);
//            }
//            calc_money(); //更新价格信息
//        });
//        return false;
//    });
//}

//得到库存并显示
function show_stock(fl_id, pr_id) {
    if (fl_id == null || pr_id == null || pr_id == undefined || fl_id == undefined) {
        $(".inventory-header>span").text("加载失败");
        return;
    }
//    $.post('/controller/overt/control.html', {_f: "client.total",_m: "query_stock",fl_id: fl_id,pr_id: pr_id,uid: uid,show_type: show_type}, function(data) {
//        if (data != null) {
//            $(".inventory-header>span").text(data.data);
//        }
//    });
}

/**
 * 支付页面显示优惠信息
 * @date   2017-02-06T12:10:50+0800
 * @param  {[type]}                 _this [description]
 * @return {[type]}                       [description]
 */
function show_favourable(_this){
    //显示优惠信息
    var show_favourable = false;
    var desc         = _this.attr("desc");
    var min_buy      = _this.attr("min-buy");
    var max_buy      = _this.attr("max-buy");
    var welfare_open = _this.attr("welfare_open");
    var welfare_data = _this.attr("welfare_data");

    if (desc != "") {
        $(".product-desc").find('.desc-content').html(desc);
        $(".product-desc").show();
        show_favourable = true;
    }else{
        $(".product-desc").hide();
    }

    if (max_buy > 0 || min_buy > 0) {
        $(".product-limit").show();
        $(".product-limit").find('.field').remove();
        if (min_buy != "0") {
            $(".limit-content").append('<i class="field">最小起购:' + min_buy + '件</i>');
        }
        if (max_buy != "0") {
            $(".limit-content").append('<i class="field">最大限购:' + max_buy + '件</i>');
        }
        show_favourable = true;
    }

    if (min_buy == "0" && max_buy == "0"){
        $(".product-limit").hide();
    }else if (min_buy == undefined && max_buy == undefined) {
        $(".product-limit").hide();
    }

    var _this = $(".product-list>.active");

    if (welfare_open == "1") {
        var welfare = parseJSON_discount(welfare_data);
        if (welfare != false) {
            $(".product-discount").find('.field').remove();
            for (var i = 0; i < welfare.length; i++) {
                pr_price = _this.attr("price");
                $(".discount-content").append('<i class="field">优惠' + (i + 1) + ': ------ 买满' + welfare[i].prece + '件,享受' + welfare[i].discount + '折,相当于'+ (welfare[i].discount * pr_price * 0.1).toFixed(2) +'元一件</i>');
            }
            $(".product-discount").show();
            show_favourable = true;
        }else{
            $(".product-discount").hide();
        }
    }else{
        $(".product-discount").hide();
    }
}

//计算并显示价格
function calc_money() {
    //计算价格
    var curr = $(".product-list>.active");
    var pr_price = curr.attr("price");
    var pr_name = curr.text().replace("(" + pr_price + " 元)","");
    var count = get_product_count();

    if (count == false) {
        return false;
    }
    //显示数量
    $(".count>.value").text("x " + count);
    if (pr_name == "") {
        $(".name>.value").text("还未选定!");
    } else if (pr_name.length > 40) {
        $(".name>.value").text(pr_name.substring(0, 40) + "...");
    } else {
        $(".name>.value").text(pr_name);
    }

    var money = pr_price * count;

    // 先使用优惠卷,再使用默认折扣
    var original_cost   = money.toFixed(2);
    // 检测是否有优惠卷
    var val_favourable_exits = favourable_exits();
    var val_favourable_used_final = false;
    var val_hide_prompt_favourable_used = true;
    if (val_favourable_exits == true) {
        // 说明使用了优惠券
        // 如果优惠卷在当前页面使用
        if (check_current_select_unable() == true) {
            // 如果优惠卷能在当前选择的商品中使用
            if (check_current_select_unable() == true) {
                // 显示出折扣信息
                var favourable_money =  favourable_reduce_money(money);
                if (typeof favourable_money == "string") {
                    // 可能是订单没有达到使用条件，需要给予提示
                    show_prompt_favourable_used();
                    val_hide_prompt_favourable_used = false;
                }else{
                    val_favourable_used_final = true;
                    money = favourable_money;
                    show_favourable_price();
                    hide_prompt_favourable_used();
                }
            }
        }
    }

    // 如果优惠卷没有生效,则需要将优惠卷信息隐藏
    if (val_favourable_used_final == false) {
        hide_favourable_price();
    }

    // 判断是否需要隐藏掉优惠卷提示情况
    if (val_hide_prompt_favourable_used == true) {
        hide_prompt_favourable_used();
    }

    if (pr_price == null) {
        money = 0;
    }

    var welfare_open = curr.attr("welfare_open");
    var welfare_data = curr.attr("welfare_data");
    var discount_result = get_discount(welfare_open,welfare_data,count);
    if (money <= 0) {
        $(".money").text("0.00");
    } else {
        if (discount_result != false) { 
            $(".discount-msg").text("(原价:" + original_cost + "元,件满已享受" + discount_result.discount.toFixed(2) * 10 + "折)");
            $(".discount-msg").show();
            money = money * discount_result.discount;
        }else{
            $(".discount-msg").hide();
        }
        if (money < 0.2) {
            money = 0.2;
        }
        $(".money").text(money.toFixed(2));
    }
}

/**
 * 传入件数,得到折扣对象
 * @date   2017-02-07T23:27:56+0800
 */
function get_discount(welfare_open,welfare_data,count){
    if (welfare_open == "1") {
        //说明有折扣
        var discount_data = parseJSON_discount(welfare_data);
        if (discount_data != false) {
            for (var i = discount_data.length - 1; i >= 0; i--) {
                var data = discount_data[i];
                if (count >= parseInt(data.prece)) {
                    return {
                        discount:data.discount * 0.1,
                        prece:data.prece,
                        count:count
                    };
                }
            }
            return false;
        }else{
            return false;
        }
    }else{
        return false;
    }
}

/**
 * 转换折扣数据
 * @date   2017-02-07T23:17:08+0800
 * @param  {[type]}                 welfare_data [description]
 * @return {[type]}                              [description]
 */
function parseJSON_discount(welfare_data){
    var discount_data = $.parseJSON(welfare_data);
    if ((typeof discount_data) == "object" && discount_data.length > 0) {
        return discount_data;
    }else{
        return false;
    }
}

/**
 * 得到购买数量
 * @date   2017-02-07T12:01:35+0800
 * @return {[type]}                 [description]
 */
function get_product_count(){
    var count = $(".inventory-list>.active").attr("data");
    if (isPositiveNum(count) == false || count == "") {
        count = $("#text-quantity").val();
        if (isPositiveNum(count) == false) {
            return false;
        }else{
            return count;
        }
    }else{
        return count;
    }
}

/**
 * 检测优惠卷是否可用
 * @date   2017-02-19T14:14:50+0800
 * true 代表使用了优惠卷
 */
function favourable_exits(){
    var value = $("#text-favourable").val();
    if (check_favourable_value(value) == false) {
        return false;
    }
    if (typeof window.yhj_data != "object" || window.yhj_data == null) {
        return false;
    }else{
        return true;
    }
}

// 隐藏总价那里显示出优惠卷的打折信息
function hide_favourable_price(){
    $(".favourable-msg").hide();
}

/**
 * 提示达到某某元后才可以使用
 * @date   2017-02-19T15:00:51+0800
 */
function hide_prompt_favourable_used(){
    $(".text-favourable-used-msg").hide();
}

/**
 * 提示达到某某元后才可以使用
 * @date   2017-02-19T15:00:51+0800
 */
function show_prompt_favourable_used(){
    if (typeof window.yhj_data != "object" || window.yhj_data == null) {
        return false;
    }else {
        $(".text-favourable-used-msg").text("提示：买满" + window.yhj_data.min_order_money + "元就可使用优惠卷").css("display","block");
    }
}

/**
 * 检测此优惠卷是否能在当前页面使用
 * @date   2017-02-19T13:16:40+0800
 */
function check_current_page_unable(){
    if (typeof window.yhj_data != "object" || window.yhj_data == null) {
        return false;
    }else {
       // 先检测商户类型
       if (window.yhj_data.type == "商户优惠卷") {
            return true;
       }else if (window.yhj_data.type == "分类优惠卷") {
            var fl_id = window.yhj_data.fl_id;
            return check_favourable_fl_id(fl_id);
       }else{
            var pr_id = window.yhj_data.pr_id;
            return check_favourable_pr_id(pr_id);
       }
    }
}

/**
 * 传入商品分类的id,检测出优惠卷是否能使用
 * @date   2017-02-19T13:40:23+0800
 */
function check_favourable_fl_id(fl_id){
    if (typeof window.yhj_data != "object" || window.yhj_data == null) {
        return false;
    }else {
        var cate = $(".cate-list").find('[data=' + fl_id + ']').text();
        if (cate == "" || cate == undefined) {
            return false;
        }else{
            return true;
        }
    }    
}

/**
 * 传入商品id,检测出优惠卷是否能使用
 * @date   2017-02-19T13:40:54+0800
 */
function check_favourable_pr_id(pr_id){
    if (typeof window.yhj_data != "object" || window.yhj_data == null) {
        return false;
    }else {
        var product = $(".product-list").find('[pr=' + pr_id + ']').text();
        if (product == "" || product == undefined) {
            return false;
        }else{
            return true;
        }
    }   
}

/**
 * 检测优惠卷是否在当前选择的商品中使用
 * @date   2017-02-19T14:20:16+0800
 */
function check_current_select_unable(){
    if (typeof window.yhj_data != "object" || window.yhj_data == null) {
        return false;
    }else {       // 先检测商户类型
       if (window.yhj_data.type == "商户优惠卷") {
            return true;
       }else if (window.yhj_data.type == "分类优惠卷") {
            var yhj_fl_id = window.yhj_data.fl_id;
            var current_fl_id = get_current_fl_id();
            if (yhj_fl_id == current_fl_id) {
                return true;
            }else{
                return false;
            }
       }else{
            var pr_id = window.yhj_data.pr_id;
            var current_pr_id = get_current_pr_id();
            if (pr_id == current_pr_id) {
                return true;
            }else{
                return false;
            }
       }
   }
}


/**
 * 得到当前选择的商品分类id
 * @date   2017-02-19T14:22:09+0800
 */
function get_current_fl_id(){
    var fl_id = $(".cate-list").find(".active").attr("data");
    if (fl_id == "") {
        return null;                            
    }else{
        return fl_id;
    }
}

/**
 * 得到当前选择的商品id
 * @date   2017-02-19T14:22:09+0800
 */
function get_current_pr_id(){
    var pr_id = $(".product-list").find(".active").attr("pr");
    if (pr_id == "") {
        return null;                            
    }else{
        return pr_id;
    }
}

/**
 * 传入总价,计算出优惠后的价格
 * @date   2017-02-19T13:56:11+0800
 * 一般是返回true,
 */
function favourable_reduce_money(money){
    var _this_money = parseFloat(money);
    var _this_min_order_money = parseFloat(window.yhj_data.min_order_money);
    if (window.yhj_data.min_order_money != "0") {
        // 说明是有订单显示
        if (_this_money < _this_min_order_money) {
            return "订单未满"+ _this_min_order_money +"元,优惠卷不可用";
        }
    }
    var result = 0;
    // 计算价格了
    if (window.yhj_data.price_type == "2") {
        // 金额优惠卷
        result = _this_money - window.yhj_data.value;
    }else{
        result = _this_money * (window.yhj_data.value/10);
    }
    // 判断总价是否小于0.2
    if (result < 0.2) {
        return 0.2;
    }else{
        return result;
    }
}

// 在总价那里显示出优惠卷的打折信息
function show_favourable_price(){
    if (typeof window.yhj_data != "object" || window.yhj_data == null) {
        return false;
    }else {
        if (window.yhj_data.price_type == "2") {
            // 金额优惠卷
             $(".favourable-msg").text("(优惠卷：立减"+ window.yhj_data.value +"元)");
        }else{
             $(".favourable-msg").text("(优惠卷：" + window.yhj_data.value + "折优惠)");
        }
        $(".favourable-msg").show();
    }
}

// 删除全部惠字
function del_favourable_font(){
    $(".min-favourable").remove();  
}

// 显示惠字
function show_favourable_font(data){
    del_favourable_font();
    if (data.type == "商户优惠卷") {
        $(".cate-list>a").append('<i class="min-favourable">(惠)</i>');
        $(".product-list>a").append('<i class="min-favourable">(惠)</i>');
    }else if (data.type == "分类优惠卷") {
        $(".cate-list>a[data="+ data.fl_id +"]").append('<i class="min-favourable">(惠)</i>');        
    }else if (data.type == "商品优惠卷") {
        $(".product-list>a[data="+ data.pr_id +"]").append('<i class="min-favourable">(惠)</i>');
    }else{
        return false;
    }
}

function _msg_close(){
    $("._msg").hide();
    $("._msg_botton").hide();
    clearTimeout(window._msg_clock);
}

//调整订单确认框的左边
function calc_left() {
    var window_width = $(window).width();
    var window_height = $(window).height();
    var ddqr_width = $("#ddqr").width();
    var ddqr_height = $("#ddqr").height();
    var left = window_width / 2 - ddqr_width / 2;
    var top = window_height / 2 - ddqr_height / 1.5;
    $("#ddqr").css("left", left.toString() + "px");
    $("#ddqr").css("top", top.toString() + "px");
    $(".shade").css('display', 'block');
    $("#ddqr").show();
}

//获取当前的日期时间 格式“yyyy-MM-dd HH:MM:SS”
function getNowFormatDate() {
    var date = new Date();
    var seperator1 = "-";
    var seperator2 = ":";
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate + " " + date.getHours() + seperator2 + date.getMinutes() + seperator2 + date.getSeconds();
    return currentdate;
}

/**
 * 隐藏订单信息框
 * @date   2017-02-08T23:19:59+0800
 */
function close_order_box(){
    $(".shade").removeAttr('style');
    $("#ddqr").fadeOut(200)
    $("#wxzf").removeAttr('style');
    $(".wx-shade").css('display', "none");
    click_to_pay_count = 0;
}

// 标记加载中
function start_loading() {
    $('.loading-left').stop();
    $('.loading-right').stop();
    $(".loading-left").css("width","0%");
    $(".loading-right").css("width","5%");
    $("#kfk-loading").show();
    window.loading = true;
    $(".loading-left").animate({"width":'90%'},3000,function(){
        if (window.loading = true) {
            slow_loading();
        }else{
            close_loading();
        }
    });
    $(".loading-right").animate({"width":'0%'},2000);
}

// 关闭加载中
function close_loading() {
    $('.loading-left').stop();
    $('.loading-right').stop();
    $(".loading-right").css("width",'0%');
    $(".loading-left").animate({"width":'100%'},500,function(){
        $("#kfk-loading").hide();
    });
}

// 缓慢加载
function slow_loading(){
    $(".loading-left").animate({"width":'98%'},10000,function(){});
}

/**
 * 显示正在付款
 * @date   2017-02-08T19:09:54+0800
 * @return {[type]}                 [description]
 */
function show_paying(){
    $('html, body').animate({scrollTop:0}, 'slow');
    var link_man  = $("#text-obligate").val();
    var order_num = $("[name=order_num]").val();
    $(".value>[name=link-man]").text(link_man);
    $(".value>[name=order]").text(order_num);
    $(".div-paying-shadow").show();
    
    var window_width = $(window).width();
    var paying_width = $(".div-paying").width() + 50;
    $(".div-paying").css('left', window_width/2 - paying_width/2);
    $(".div-paying").show();
    //显示正在付款
    time_pay_ing = self.setInterval("pay_ing()", 500);
}

//判断订单号是否已经付款和发货
function check_pay($order_num) {
    $.post('/controller/overt/control.html', {_f: "client.total",_m: "order_state",order_num: $order_num}, function(data) {
        if (data.state == "ok") {
            _msg("支付成功了!");
            location.href = "/order/state/" + $order_num + "/" + $("[name=link]").val() + ".html";
            window.clearInterval(window.time_id);
        } else if (data.state == "out") {
            //_msg("订单支付超时!");
            window.clearInterval(window.time_id);
        }
    });
}

function hide_paying(){
    window.clearInterval(time_pay_ing);
    $(".div-paying").hide();
    $(".div-paying-shadow").hide();
}

/**
 * 动态显示正在付款
 * @date   2017-02-08T19:15:32+0800
 * @return {[type]}                 [description]
 */
function pay_ing(){
    var msg = $(".div-paying>.jt").text();
    if (msg == "·····正在监听付款状态·····") {
        $(".div-paying>.jt").text("正在监听付款状态");
    }else {
        $(".div-paying>.jt").text("·" + msg + "·");
    }
}

//调整微信支付二维码显示框位置
function calc_left_wx() {
    var order_num = $("[name=order_num]").val();
    var window_width = $(window).width();
    var ddqr_width = $("#wxzf").width();
    var ddqr_height = $("#wxzf").height();
    var left = window_width / 2 - ddqr_width / 2;
    $("#wxzf").css("left", left.toString() + "px");
    $(".shade").show();
    $("#wxzf").css('display', 'block');
    $(".order-info>label").text("订单号:" + order_num);
}

// 关闭土司框
function _msg_close(){
    $("._msg").hide();
    $("._msg_botton").hide();
    $("._msg").css("padding-right","35px");
}

// 土司框 ﻿_msg("6666",-1,"好的");
function _msg(msg){
    _msg_close();
    $("._msg").text(msg);
    var dom_width = $("._msg").width();
    var window_width = $(window).width();
    var window_height = $(window).height();
    var dom_left = window_width / 2 - dom_width / 2;
    $("._msg").css({'left':dom_left - 30 + "px","top":window_height * 0.28 + "px"}).show();;
    if (arguments[2] != undefined && arguments[2] != null) {
        _msg_botton(arguments[2]);
    }
    // 关闭之前的计时
    clearTimeout(window._msg_clock);
    if (arguments[1] != -1) {
        if (arguments[1] == undefined || arguments[1] == null) {
            window._msg_clock = setTimeout("_msg_close()",5000);
        }else{
            window._msg_clock = setTimeout("_msg_close()",arguments[1]);
        }
    }
}

// 土司框上面的按钮
function _msg_botton(title){
    var botton_width = $("._msg_botton").text(title).width() + 45;
    var _msg_left = $("._msg").css("left").replace("px","");
    var _msg_top = $("._msg").css("top").replace("px","");
    var _msg_width = $("._msg").width();

    $("._msg").css("padding-right",botton_width * 1 + 15 + "px");
    $("._msg_botton").css('top', _msg_top * 1 + 12 + "px");
    $("._msg_botton").css('left', _msg_left * 1 + _msg_width + 50 + "px");
    $("._msg_botton").show();

    // 调整框的位置
    var dom_width = $("._msg").width();
    var window_width = $(window).width();
    var dom_left = window_width / 2 - dom_width / 2;
    $("._msg").css('left', dom_left - 30 + "px");
}